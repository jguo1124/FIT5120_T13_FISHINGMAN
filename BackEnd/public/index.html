<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GoFish Home</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#0e1b2a;background:linear-gradient(180deg,#eef7ff 0%,#ffffff 40%) no-repeat}
    header{padding:24px 28px;border-bottom:1px solid #e8eef5;background:linear-gradient(135deg,#0ea5e9 0%,#2563eb 50%,#0ea5e9 100%);color:#fff}
    main{padding:28px;min-height:60vh}
    h1{margin:0 0 6px;font-size:22px}
    p{margin:0;color:#e6f3ff}

    :root{--gf-primary:#0ea5e9;--gf-primary-2:#2563eb;--gf-bg:#ffffff;--gf-border:#e6edf5;--gf-text:#07233b}
    .gofish-btn{position:fixed;right:24px;bottom:24px;width:60px;height:60px;border-radius:16px;border:none;background:linear-gradient(135deg,var(--gf-primary) 0%,var(--gf-primary-2) 100%);color:#fff;box-shadow:0 12px 30px rgba(37,99,235,.35);cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .gofish-btn::after{content:"";position:absolute;inset:-30%;background:radial-gradient(60% 60% at 20% 20%,rgba(255,255,255,.28),transparent 60%);animation:ripple 6s linear infinite;opacity:.7;pointer-events:none}
    @keyframes ripple{0%{transform:translate3d(0,0,0) scale(1)}50%{transform:translate3d(10%,10%,0) scale(1.08)}100%{transform:translate3d(0,0,0) scale(1)}}
    .gofish-btn svg{width:28px;height:28px;position:relative;z-index:1}
    .gofish-panel{position:fixed;right:24px;bottom:96px;width:380px;max-height:72vh;background:var(--gf-bg);border:1px solid var(--gf-border);border-radius:18px;box-shadow:0 16px 42px rgba(0,38,84,.18);display:none;flex-direction:column;overflow:hidden}
    .gofish-header{padding:12px 14px;border-bottom:1px solid #eef3f8;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#f6fbff,#ffffff)}
    .gofish-title{display:flex;gap:10px;align-items:center;font-weight:800;color:var(--gf-text)}
    .gofish-title svg{width:22px;height:22px}
    .gofish-close{background:none;border:none;font-size:18px;cursor:pointer;line-height:1;color:#5b6b7a}
    .gofish-body{padding:14px;height:360px;overflow:auto;background:linear-gradient(180deg,#f8fcff 0%,#fafcff 100%)}
    .gofish-msg{margin:10px 0;display:flex;gap:8px}
    .gofish-msg.user{justify-content:flex-end}
    .gofish-bubble{max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.45;box-shadow:0 2px 10px rgba(0,33,71,.06);font-size:14px;white-space:pre-wrap;word-break:break-word}
    .gofish-bubble.user{background:linear-gradient(135deg,var(--gf-primary),var(--gf-primary-2));color:#fff;border-bottom-right-radius:6px}
    .gofish-bubble.bot{background:#fff;border:1px solid #edf2f8;border-bottom-left-radius:6px}
    .gofish-footer{border-top:1px solid #eef3f8;padding:10px;display:flex;flex-direction:column;gap:8px;background:#fff}
    .gofish-composer{display:flex;align-items:center;gap:8px;border:1px solid #e2eaf3;border-radius:12px;padding:8px 10px;background:#f9fbfe}
    .gofish-input{flex:1;border:none;background:transparent;outline:none;font-size:14px;color:#0e1b2a}
    .gofish-icon{width:34px;height:34px;border-radius:10px;border:none;background:#fff;border:1px solid #e3ebf4;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .gofish-icon svg{width:18px;height:18px}
    .gofish-send{background:linear-gradient(135deg,var(--gf-primary),var(--gf-primary-2));border:none;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .gofish-send[disabled]{opacity:.6;cursor:not-allowed}
    .gofish-preview{display:none;align-items:center;gap:8px}
    .gofish-chip{display:flex;align-items:center;gap:8px;background:#eef6ff;border:1px solid #d6e8ff;color:#0b3a66;padding:6px 8px;border-radius:10px}
    .gofish-chip img{width:36px;height:36px;object-fit:cover;border-radius:8px}
    .gofish-chip button{border:none;background:transparent;color:#0b3a66;cursor:pointer}
    .gofish-drop{outline:2px dashed #bcd8ff;outline-offset:6px}
    ::-webkit-scrollbar{width:10px}
    ::-webkit-scrollbar-thumb{background:#dfe9f5;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <h1>GoFish Home</h1>
    <p>这是最小前端示例页，你可以直接在此体验 AI 助手。</p>
  </header>
  <main>
    <p>提示：右下角点击“AI”按钮打开对话窗，支持文字与图片上传。</p>
  </main>

  <div id="gofish-panel" class="gofish-panel" role="dialog" aria-modal="true" aria-label="GoFish Assistant">
    <div class="gofish-header">
      <div class="gofish-title">
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill="none">
          <defs>
            <linearGradient id="w" x1="0" y1="0" x2="48" y2="48" gradientUnits="userSpaceOnUse">
              <stop stop-color="#0ea5e9"/>
              <stop offset="1" stop-color="#2563eb"/>
            </linearGradient>
          </defs>
          <path d="M6 30c6-2 12-2 18 0s12 2 18 0" stroke="url(#w)" stroke-width="2.2" stroke-linecap="round"/>
          <path d="M18 26l6-4 6 4" stroke="url(#w)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M18 26l-2 2" stroke="url(#w)" stroke-width="2.2" stroke-linecap="round"/>
          <circle cx="30" cy="23" r="1.4" fill="#2563eb"/>
        </svg>
        <span>GoFish Assistant</span>
      </div>
      <button class="gofish-close" aria-label="close" onclick="GF.hide()">×</button>
    </div>
    <div id="gofish-body" class="gofish-body" aria-live="polite"></div>
    <div class="gofish-footer">
      <div id="gofish-preview" class="gofish-preview"></div>
      <div id="gofish-composer" class="gofish-composer">
        <input id="gofish-input" class="gofish-input" placeholder="输入问题，或拖拽/粘贴图片..." autocomplete="off">
        <input id="gofish-file" type="file" accept="image/*" style="display:none">
        <button id="gofish-attach" class="gofish-icon" title="上传图片" aria-label="上传图片">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17l4.5-4.5 3 3L17 9l4 4" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button id="gofish-send" class="gofish-send" onclick="GF.send()">发送</button>
      </div>
    </div>
  </div>
  <button class="gofish-btn" onclick="GF.toggle()" aria-haspopup="dialog" aria-controls="gofish-panel" title="GoFish Assistant">
    <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill="none">
      <path d="M6 32c6-2 12-2 18 0s12 2 18 0" stroke="#ffffff" stroke-width="2.4" stroke-linecap="round"/>
      <path d="M18 26l6-4 6 4" stroke="#ffffff" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="30" cy="23" r="1.6" fill="#ffffff"/>
    </svg>
  </button>

  <script>
    (function(){
      const GF = (() => {
        const apiBase = "/api/ai"; //
        const sidKey = "gofish_session_id";
        function sessionId(){
          let s = localStorage.getItem(sidKey);
          if(!s){ s = "web-" + Math.random().toString(36).slice(2); localStorage.setItem(sidKey, s); }
          return s;
        }

        const panel = document.getElementById("gofish-panel");
        const body  = document.getElementById("gofish-body");
        const input = document.getElementById("gofish-input");
        const file  = document.getElementById("gofish-file");
        const sendBtn = document.getElementById("gofish-send");
        const previewWrap = document.getElementById("gofish-preview");
        const composer = document.getElementById("gofish-composer");
        const attachBtn = document.getElementById("gofish-attach");

        function toggle(){ if(panel.style.display === "flex"){ hide(); } else { show(); } }
        function show(){ panel.style.display = "flex"; input && input.focus(); }
        function hide(){ panel.style.display = "none"; }

        function addMsg(text, who="bot"){
          const row = document.createElement("div");
          row.className = "gofish-msg " + (who==="user"?"user":"bot");
          const bubble = document.createElement("div");
          bubble.className = "gofish-bubble " + (who==="user"?"user":"bot");
          bubble.textContent = text || "";
          row.appendChild(bubble);
          body.appendChild(row);
          body.scrollTop = body.scrollHeight;
          return bubble; // 让调用方可持续写入
        }

        function setSending(sending){
          if(!sendBtn) return;
          sendBtn.disabled = !!sending;
          sendBtn.textContent = sending ? "发送中..." : "发送";
        }

        function setPreview(fileObj, dataUrl){
          previewWrap.innerHTML = "";
          if(!fileObj){ previewWrap.style.display = "none"; return; }
          const chip = document.createElement("div");
          chip.className = "gofish-chip";
          const img = document.createElement("img");
          img.src = dataUrl;
          const name = document.createElement("span");
          name.textContent = fileObj.name || "图片";
          const rm = document.createElement("button");
          rm.textContent = "×";
          rm.onclick = () => { previewWrap.style.display = "none"; previewWrap.innerHTML = ""; file.value = ""; };
          chip.appendChild(img); chip.appendChild(name); chip.appendChild(rm);
          previewWrap.appendChild(chip);
          previewWrap.style.display = "flex";
        }

        async function send(){
          const prompt = (input.value||"").trim();
          const f = file.files[0];
          if(!prompt && !f){ return; }
          show();
          if(prompt){ addMsg(prompt, "user"); }
          input.value = "";

          try{
            setSending(true);
            let answer;
            if(f){
              const fd = new FormData();
              fd.append("sessionId", sessionId());
              fd.append("prompt", prompt || "请描述这张图片");
              fd.append("file", f);
              const resp = await fetch(apiBase + "/chat-upload", { method: "POST", body: fd });
              const data = await resp.json();
              if(!resp.ok) throw new Error(data?.error || "上传失败");
              answer = data.answer || "[空响应]";
              file.value = ""; setPreview(null, null);
            }else{
              // 文本走流式接口
              const resp = await fetch(apiBase + "/stream", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sessionId: sessionId(), prompt })
              });
              const reader = resp.body.getReader();
              const decoder = new TextDecoder("utf-8");
              const bubble = addMsg("", "bot");
              let doneAll = false;
              while(!doneAll){
                const { value, done } = await reader.read();
                if(done){ break; }
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split("\n\n").filter(l => l.trim().startsWith("data:"));
                for(const line of lines){
                  const data = line.replace("data: ","");
                  if(data === "[DONE]"){ doneAll = true; break; }
                  try{
                    const json = JSON.parse(data);
                    if(json.delta){ bubble.textContent += json.delta; body.scrollTop = body.scrollHeight; }
                  }catch{}
                }
              }
            }
          }catch(e){
            addMsg("请求失败: " + (e && e.message ? e.message : e), "bot");
          }finally{
            setSending(false);
          }
        }

        input && input.addEventListener("keydown", (e)=>{
          if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
        });

        // 选择文件按钮
        attachBtn && attachBtn.addEventListener("click", ()=> file && file.click());
        file && file.addEventListener("change", ()=>{
          const f = file.files[0]; if(!f) return setPreview(null);
          const reader = new FileReader(); reader.onload = () => setPreview(f, reader.result); reader.readAsDataURL(f);
        });

        // 支持粘贴图片
        document.addEventListener("paste", (e)=>{
          const item = e.clipboardData && e.clipboardData.items && Array.from(e.clipboardData.items).find(i=> i.type && i.type.startsWith("image/"));
          if(!item) return;
          const blob = item.getAsFile();
          const dt = new DataTransfer(); dt.items.add(blob); file.files = dt.files;
          const reader = new FileReader(); reader.onload = () => setPreview(blob, reader.result); reader.readAsDataURL(blob);
        });

        // 拖拽图片
        composer && ["dragover","dragleave","drop"].forEach(evt=>{
          composer.addEventListener(evt,(e)=>{
            if(evt!=="dragleave") e.preventDefault();
            if(evt==="dragover") composer.classList.add("gofish-drop");
            if(evt==="dragleave") composer.classList.remove("gofish-drop");
            if(evt==="drop"){ composer.classList.remove("gofish-drop"); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(!f) return; if(!f.type.startsWith("image/")) return; const dt=new DataTransfer(); dt.items.add(f); file.files = dt.files; const reader=new FileReader(); reader.onload=()=> setPreview(f, reader.result); reader.readAsDataURL(f);}        
          });
        });

        return { toggle, show, hide, send };
      })();
      window.GF = GF;
    })();
  </script>
</body>
</html>


